services:
  app:
    build:
      context: .
      dockerfile: dockerfile
    image: api-node-app:latest
    env_file:
      - .env
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=mongodb://mongo:27017/willdb
    depends_on:
      - mongo
    restart: unless-stopped

  mongo:
    image: mongo:6.0
    command: ["--replSet", "rs0", "--bind_ip_all"]
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=willdb
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  mongo-init:
    image: mongo:6.0
    depends_on:
      mongo:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command: |
      until mongosh --host mongo --eval "rs.initiate({_id: 'rs0', members: [{ _id: 0, host: 'mongo:27017' }]})" 2>/dev/null; do
        echo 'Waiting for mongo to be ready...' ; sleep 2
      done
    restart: "no"

volumes:
  mongo-data:
    driver: local
